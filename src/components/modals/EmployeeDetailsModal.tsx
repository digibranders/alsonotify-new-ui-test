import { useState, useMemo } from 'react';
import { Modal, Button, App } from 'antd';
import { Briefcase, Mail, Phone, Calendar, DollarSign, Clock, CalendarDays, X, FileText, Users, Globe, ShieldAlert, Linkedin, Github } from 'lucide-react';
import { AccessBadge } from '../ui/AccessBadge';
import { Employee, UserDocument } from '@/types/genericTypes';
import { DocumentCard } from '@/components/ui/DocumentCard';
import { DocumentPreviewModal } from '@/components/ui/DocumentPreviewModal';

interface EmployeeDetailsModalProps {
  open: boolean;
  onClose: () => void;
  employee: Employee | null;
  onEdit: () => void;
}

export function EmployeeDetailsModal({
  open,
  onClose,
  employee,
  onEdit,
}: EmployeeDetailsModalProps) {
  const { message } = App.useApp();
  // Documents state
  const [selectedDocument, setSelectedDocument] = useState<UserDocument | null>(null);
  const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);

  const documents = useMemo(() => {
    // Check if employee data has documents
    return (employee as any)?.documents || [];
  }, [employee]);

  if (!employee) return null;

  // Format date of joining
  const formatDate = (dateString: string) => {
    if (!dateString || dateString === 'N/A') return 'N/A';
    try {
      const parts = dateString.split('-');
      if (parts.length === 3) {
        return dateString;
      }
      const date = new Date(dateString);
      if (!isNaN(date.getTime())) {
        const day = date.getDate().toString().padStart(2, '0');
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      }
    } catch (e) {
      // Error formatting date
    }
    return dateString;
  };

  // Parse skillsets
  const skills = employee.skillsets && employee.skillsets !== 'None'
    ? employee.skillsets.split(',').map(s => s.trim()).filter(s => s.length > 0)
    : [];

  // Format hourly rate
  const hourlyRate = employee.hourlyRate && employee.hourlyRate !== 'N/A'
    ? employee.hourlyRate
    : 'N/A';

  // Format experience
  const experience = employee.experience ? `${employee.experience} Years` : 'N/A';

  // Format working hours
  const workingHours = (() => {
    if (employee.rawWorkingHours?.start_time && employee.rawWorkingHours?.end_time) {
      return `${employee.rawWorkingHours.start_time} - ${employee.rawWorkingHours.end_time}`;
    }
    return employee.workingHours ? `${employee.workingHours}h / week` : 'N/A';
  })();

  // Format leaves
  const leavesTaken = employee.leaves ? `${employee.leaves} Days` : '0 Days';

  const handleDocumentPreview = (document: UserDocument) => {
    setSelectedDocument(document);
    setIsPreviewModalOpen(true);
  };

  const handleDocumentDownload = (document: UserDocument) => {
    if (document.fileUrl) {
      window.open(document.fileUrl, '_blank');
    } else {
      message.warning('Document URL not available');
    }
  };

  const handleDocumentUpload = (documentTypeId: string) => {
    message.info(`Upload functionality for document type ${documentTypeId} - To be implemented`);
  };

  return (
    <Modal
      open={open}
      onCancel={onClose}
      footer={null}
      width={700}
      centered
      className="rounded-[16px] overflow-hidden"
      closeIcon={<X className="w-5 h-5 text-[#666666]" />}
      styles={{
        body: {
          padding: 0,
        }
      }}
    >
      <div className="flex flex-col max-h-[90vh] bg-white">
        {/* Fixed Header - Reduced padding */}
        <div className="flex-shrink-0 border-b border-[#EEEEEE] px-6 py-4 bg-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-11 h-11 rounded-full overflow-hidden border border-[#EEEEEE] bg-[#F7F7F7] flex-shrink-0">
                <img
                  src={employee.profile_pic || `https://ui-avatars.com/api/?name=${encodeURIComponent(employee.name)}&background=f7f7f7&color=666`}
                  alt={employee.name}
                  className="w-full h-full object-cover"
                />
              </div>
              <div>
                <h2 className="text-[18px] font-['Manrope:Bold',sans-serif] text-[#111111] leading-tight">
                  {employee.name}
                </h2>
                <div className="flex items-center gap-2 mt-0.5">
                  <AccessBadge role={employee.access} color={employee.roleColor} />
                  <span
                    className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[9px] font-['Manrope:SemiBold',sans-serif] ${employee.status === 'active'
                      ? 'bg-[#ECFDF3] text-[#12B76A]'
                      : 'bg-[#FEF3F2] text-[#F04438]'
                      }`}
                  >
                    <span className="w-1 h-1 rounded-full bg-current"></span>
                    {employee.status === 'active' ? 'Active' : 'Inactive'}
                  </span>
                </div>
              </div>
            </div>

            <div className="flex items-center gap-1 pr-6">
              <Button
                type="text"
                icon={<Mail className="w-4 h-4 text-[#666666]" />}
                onClick={() => window.location.href = `mailto:${employee.email}`}
                className="hover:bg-[#F7F7F7] rounded-full w-8 h-8 flex items-center justify-center p-0"
                aria-label={`Send email to ${employee.name}`}
              />
              <Button
                type="text"
                icon={<Phone className="w-4 h-4 text-[#666666]" />}
                onClick={() => window.location.href = `tel:${employee.phone}`}
                className="hover:bg-[#F7F7F7] rounded-full w-8 h-8 flex items-center justify-center p-0"
                aria-label={`Call ${employee.name}`}
              />

              {(employee.linkedin || employee.github || employee.portfolio) && (
                <>
                  <div className="mx-1.5 w-[1px] h-4 bg-[#EEEEEE]"></div>
                  {employee.linkedin && (
                    <Button
                      type="text"
                      icon={<Linkedin className="w-4 h-4 text-[#0077B5]" />}
                      onClick={() => window.open(employee.linkedin!.startsWith('http') ? employee.linkedin : `https://linkedin.com/in/${employee.linkedin}`, '_blank')}
                      className="hover:bg-[#F7F7F7] rounded-full w-8 h-8 flex items-center justify-center p-0"
                      aria-label={`Visit ${employee.name}'s LinkedIn profile`}
                    />
                  )}
                  {employee.github && (
                    <Button
                      type="text"
                      icon={<Github className="w-4 h-4 text-[#111111]" />}
                      onClick={() => window.open(employee.github!.startsWith('http') ? employee.github : `https://github.com/${employee.github}`, '_blank')}
                      className="hover:bg-[#F7F7F7] rounded-full w-8 h-8 flex items-center justify-center p-0"
                      aria-label={`Visit ${employee.name}'s GitHub profile`}
                    />
                  )}
                  {employee.portfolio && (
                    <Button
                      type="text"
                      icon={<Globe className="w-4 h-4 text-[#666666]" />}
                      onClick={() => window.open(employee.portfolio!.startsWith('http') ? employee.portfolio : `https://${employee.portfolio}`, '_blank')}
                      className="hover:bg-[#F7F7F7] rounded-full w-8 h-8 flex items-center justify-center p-0"
                      aria-label={`Visit ${employee.name}'s portfolio`}
                    />
                  )}
                </>
              )}
            </div>
          </div>
        </div>

        {/* Scrollable Body - Ensuring flex-1 and overflow-y-auto */}
        <div className="flex-1 overflow-y-auto px-6 py-6 scrollbar-thin scrollbar-thumb-gray-200 scrollbar-track-transparent space-y-8">
          {/* Section 1: Basic Information */}
          <section>
            <div className="flex items-center gap-2 mb-4">
              <div className="w-1 h-4 bg-[#111111] rounded-full"></div>
              <h3 className="text-[14px] font-['Manrope:Bold',sans-serif] text-[#111111]">Basic Information</h3>
            </div>
            <div className="grid grid-cols-2 gap-y-5 gap-x-12 pl-3">
              <DetailItem label="Email Address" value={employee.email} icon={<Mail className="w-3.5 h-3.5" />} />
              <DetailItem label="Phone Number" value={employee.phone} icon={<Phone className="w-3.5 h-3.5" />} />
              <DetailItem label="Department" value={employee.department} icon={<Users className="w-3.5 h-3.5" />} />
              <DetailItem label="Designation" value={employee.role} icon={<Briefcase className="w-3.5 h-3.5" />} />
            </div>
            {employee.bio && (
              <div className="mt-5 pl-3">
                <p className="text-[11px] font-['Manrope:Bold',sans-serif] text-[#999999] uppercase tracking-wider mb-2">
                  Professional Bio
                </p>
                <p className="text-[13px] text-[#444444] leading-relaxed font-['Manrope:Regular',sans-serif] bg-[#F9FAFB] p-4 rounded-xl border border-[#EEEEEE]">
                  {employee.bio}
                </p>
              </div>
            )}
          </section>

          {/* Section 2: Employment & HR Details */}
          <section>
            <div className="flex items-center gap-2 mb-4">
              <div className="w-1 h-4 bg-[#111111] rounded-full"></div>
              <h3 className="text-[14px] font-['Manrope:Bold',sans-serif] text-[#111111]">Employment & HR Details</h3>
            </div>
            <div className="grid grid-cols-3 gap-4 mb-6 pl-3">
              <StatCard label="Experience" value={experience} icon={<Briefcase className="w-4 h-4 text-gray-400" />} />
              <StatCard label="Total Leaves" value={leavesTaken} icon={<CalendarDays className="w-4 h-4 text-gray-400" />} />
              <StatCard label="Working Hours" value={workingHours} icon={<Clock className="w-4 h-4 text-gray-400" />} />
            </div>
            <div className="grid grid-cols-2 gap-y-5 gap-x-12 pl-3">
              <DetailItem label="Date of Joining" value={formatDate(employee.dateOfJoining)} icon={<Calendar className="w-3.5 h-3.5" />} />
              <DetailItem label="Annual Salary" value={employee.salary ? `${employee.currency || '$'} ${Number(employee.salary).toLocaleString()}` : 'N/A'} icon={<DollarSign className="w-3.5 h-3.5" />} />
              <DetailItem label="Hourly Cost" value={hourlyRate} icon={<DollarSign className="w-3.5 h-3.5" />} />
              <DetailItem label="Employment Type" value={employee.employmentType || "Full-time"} icon={<Briefcase className="w-3.5 h-3.5" />} />
              {employee.timezone && (
                <DetailItem label="Local Timezone" value={employee.timezone} icon={<Globe className="w-3.5 h-3.5" />} />
              )}
            </div>

            {/* Emergency Contact Sub-section */}
            {(employee.emergencyContactName || employee.emergencyContactPhone) && (
              <div className="mt-6 ml-3 p-4 bg-[#FEF3F2] rounded-xl border border-[#FEE4E2] flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#F04438] shadow-sm">
                    <ShieldAlert className="w-5 h-5" />
                  </div>
                  <div>
                    <p className="text-[11px] font-['Manrope:Bold',sans-serif] text-[#B42318] uppercase tracking-wider">Emergency Contact</p>
                    <p className="text-[14px] font-['Manrope:SemiBold',sans-serif] text-[#912018]">{employee.emergencyContactName || 'N/A'}</p>
                  </div>
                </div>
                <div className="text-right">
                  <p className="text-[13px] font-['Manrope:Medium',sans-serif] text-[#B42318]">{employee.emergencyContactPhone || '-'}</p>
                </div>
              </div>
            )}
          </section>

          {/* Section 3: Skills & Assets */}
          <section>
            <div className="flex items-center gap-2 mb-4">
              <div className="w-1 h-4 bg-[#111111] rounded-full"></div>
              <h3 className="text-[14px] font-['Manrope:Bold',sans-serif] text-[#111111]">Skills & Documents</h3>
            </div>
            <div className="space-y-6 pl-3">
              {/* Skillsets */}
              <div>
                <p className="text-[11px] font-['Manrope:Bold',sans-serif] text-[#999999] uppercase tracking-wider mb-3">
                  Professional Skillsets
                </p>
                <div className="flex flex-wrap gap-2">
                  {skills.length > 0 ? (
                    skills.map((skill, index) => (
                      <span
                        key={index}
                        className="px-3 py-1 bg-[#F9FAFB] text-[#111111] text-[12px] font-['Manrope:Medium',sans-serif] rounded-full border border-[#EEEEEE]"
                      >
                        {skill}
                      </span>
                    ))
                  ) : (
                    <span className="text-[12px] text-[#999999] italic">No skills specified</span>
                  )}
                </div>
              </div>

              {/* Documents */}
              <div>
                <p className="text-[11px] font-['Manrope:Bold',sans-serif] text-[#999999] uppercase tracking-wider mb-3">
                  Uploaded Documents
                </p>
                {documents && documents.length > 0 ? (
                  <div className="grid grid-cols-2 gap-3 pb-4">
                    {documents.map((doc: UserDocument) => (
                      <DocumentCard
                        key={doc.id}
                        document={doc}
                        onPreview={handleDocumentPreview}
                        onDownload={handleDocumentDownload}
                        showUpload={!doc.fileUrl}
                        onUpload={handleDocumentUpload}
                      />
                    ))}
                  </div>
                ) : (
                  <div className="border border-[#EEEEEE] border-dashed rounded-xl p-6 bg-[#FAFAFA] text-center">
                    <FileText className="w-8 h-8 text-[#CCCCCC] mx-auto mb-2" />
                    <p className="text-[12px] font-['Manrope:Medium',sans-serif] text-[#666666]">
                      No documents available
                    </p>
                  </div>
                )}
              </div>
            </div>
          </section>
        </div>

        {/* Fixed Footer */}
        <div className="flex-shrink-0 border-t border-[#EEEEEE] px-6 py-4 flex items-center justify-end bg-white gap-3 rounded-b-[16px]">
          <Button
            onClick={onClose}
            className="h-10 px-6 text-[14px] font-['Manrope:SemiBold',sans-serif] text-[#666666] border border-[#EEEEEE] hover:bg-[#F9FAFB] rounded-lg"
          >
            Close
          </Button>
          <Button
            type="primary"
            onClick={() => {
              onClose();
              onEdit();
            }}
            className="h-10 px-8 rounded-lg bg-[#111111] hover:bg-[#000000] text-white text-[14px] font-['Manrope:SemiBold',sans-serif] border-none active:scale-95 transition-transform"
          >
            Edit Profile
          </Button>
        </div>
      </div>

      <DocumentPreviewModal
        open={isPreviewModalOpen}
        onClose={() => {
          setIsPreviewModalOpen(false);
          setSelectedDocument(null);
        }}
        document={selectedDocument}
      />
    </Modal>
  );
}

function DetailItem({ label, value, icon }: { label: string; value: string | null; icon: React.ReactNode }) {
  return (
    <div className="flex items-start gap-3">
      <div className="mt-1 text-[#666666] flex-shrink-0">
        {icon}
      </div>
      <div>
        <p className="text-[11px] font-['Manrope:Bold',sans-serif] text-[#999999] uppercase tracking-wider mb-0.5">
          {label}
        </p>
        <p className="text-[14px] font-['Manrope:Medium',sans-serif] text-[#111111]">
          {value || 'N/A'}
        </p>
      </div>
    </div>
  );
}

function StatCard({ label, value, icon }: { label: string; value: string; icon: React.ReactNode }) {
  return (
    <div className="bg-[#F9FAFB] rounded-xl p-4 border border-[#EEEEEE] flex items-center gap-3">
      <div className="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-[#EEEEEE] flex-shrink-0">
        {icon}
      </div>
      <div>
        <p className="text-[11px] font-['Manrope:Medium',sans-serif] text-[#666666] mb-0.5">{label}</p>
        <p className="text-[16px] font-['Manrope:Bold',sans-serif] text-[#111111]">{value}</p>
      </div>
    </div>
  );
}
